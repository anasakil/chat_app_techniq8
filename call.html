<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agora Call Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            display: flex;
            gap: 20px;
        }
        .left-panel {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
        }
        .right-panel {
            flex: 2;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
        }
        .users-list {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .user-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .user-item:hover {
            background-color: #f5f5f5;
        }
        .user-item.selected {
            background-color: #e3f2fd;
        }
        .user-item .status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .user-item .status.online {
            background-color: #4CAF50;
        }
        .user-item .status.offline {
            background-color: #9E9E9E;
        }
        .call-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        .btn-audio {
            background-color: #4CAF50;
            color: white;
        }
        .btn-video {
            background-color: #2196F3;
            color: white;
        }
        .btn-end {
            background-color: #F44336;
            color: white;
        }
        .btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .video-container {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        .video-box {
            flex: 1;
            border: 1px solid #eee;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
            height: 240px;
            background-color: #000;
        }
        .video-box .label {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        .connection-status {
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
            text-align: center;
        }
        .status-connecting {
            background-color: #FFF9C4;
        }
        .status-connected {
            background-color: #E8F5E9;
        }
        .status-disconnected {
            background-color: #FFEBEE;
        }
        .call-log {
            height: 150px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            font-size: 13px;
            margin-top: 15px;
        }
        .login-container {
            max-width: 300px;
            margin: 100px auto;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
        }
        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .login-btn {
            width: 100%;
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .incoming-call {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            display: none;
        }
        .incoming-call-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .media-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 10px;
        }
        .media-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background-color: #f5f5f5;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .media-btn:hover {
            background-color: #e0e0e0;
        }
        .media-btn.active {
            background-color: #e3f2fd;
        }
        .media-btn.muted {
            background-color: #ffebee;
        }
    </style>
</head>
<body>
    <!-- Login Form -->
    <div id="login-container" class="login-container">
        <h2>Login to Test Agora Call</h2>
        <div class="form-group">
            <label for="email">Email:</label>
            <input type="email" id="email" placeholder="Enter your email">
        </div>
        <div class="form-group">
            <label for="password">Password:</label>
            <input type="password" id="password" placeholder="Enter your password">
        </div>
        <button id="login-btn" class="login-btn">Login</button>
    </div>

    <!-- Main Application -->
    <div id="app-container" style="display: none;">
        <h1>Agora Call Test</h1>
        <div class="connection-status" id="connection-status">Connecting to server...</div>
        
        <div class="container">
            <div class="left-panel">
                <h2>Online Users</h2>
                <div class="users-list" id="users-list">
                    <!-- Users will be added here dynamically -->
                </div>
                <div class="call-controls">
                    <button id="audio-call-btn" class="btn btn-audio" disabled>Audio Call</button>
                    <button id="video-call-btn" class="btn btn-video" disabled>Video Call</button>
                </div>
            </div>
            
            <div class="right-panel">
                <h2>Call</h2>
                <div class="video-container">
                    <div class="video-box">
                        <div id="local-stream-container"></div>
                        <div class="label">You</div>
                    </div>
                    <div class="video-box">
                        <div id="remote-stream-container"></div>
                        <div class="label">Remote</div>
                    </div>
                </div>
                <div class="media-controls">
                    <button id="mic-btn" class="media-btn" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
                    </button>
                    <button id="video-btn" class="media-btn" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="23 7 16 12 23 17 23 7"></polygon><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg>
                    </button>
                    <button id="end-call-btn" class="btn btn-end" disabled>End Call</button>
                </div>
                <h3>Call Log</h3>
                <div class="call-log" id="call-log"></div>
            </div>
        </div>
    </div>

    <!-- Incoming Call Notification -->
    <div id="incoming-call" class="incoming-call">
        <h3>Incoming Call</h3>
        <p id="caller-info">Someone is calling you</p>
        <div class="incoming-call-buttons">
            <button id="accept-call-btn" class="btn btn-audio">Accept</button>
            <button id="reject-call-btn" class="btn btn-end">Reject</button>
        </div>
    </div>

    <!-- Include Socket.io -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    
    <!-- Include Agora SDK -->
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>
    
    <script>
        // Constants
        const API_URL = 'http://localhost:4400/api';
        const AGORA_APP_ID = 'd35effd01b264bac87f3e87a973d92a9'; 
        
        // DOM Elements
        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const connectionStatus = document.getElementById('connection-status');
        const usersList = document.getElementById('users-list');
        const audioCallBtn = document.getElementById('audio-call-btn');
        const videoCallBtn = document.getElementById('video-call-btn');
        const endCallBtn = document.getElementById('end-call-btn');
        const micBtn = document.getElementById('mic-btn');
        const videoBtn = document.getElementById('video-btn');
        const localStreamContainer = document.getElementById('local-stream-container');
        const remoteStreamContainer = document.getElementById('remote-stream-container');
        const callLog = document.getElementById('call-log');
        const incomingCallDiv = document.getElementById('incoming-call');
        const callerInfo = document.getElementById('caller-info');
        const acceptCallBtn = document.getElementById('accept-call-btn');
        const rejectCallBtn = document.getElementById('reject-call-btn');
        
        // State variables
        let currentUser = null;
        let token = localStorage.getItem('token');
        let socket = null;
        let selectedUserId = null;
        let selectedUsername = null;
        let agoraManager = null;
        
        // Event Listeners
        document.getElementById('login-btn').addEventListener('click', login);
        audioCallBtn.addEventListener('click', () => initiateCall('audio'));
        videoCallBtn.addEventListener('click', () => initiateCall('video'));
        endCallBtn.addEventListener('click', endCall);
        micBtn.addEventListener('click', toggleMicrophone);
        videoBtn.addEventListener('click', toggleVideo);
        acceptCallBtn.addEventListener('click', acceptIncomingCall);
        rejectCallBtn.addEventListener('click', rejectIncomingCall);
        
        // Check if already logged in
        if (token) {
            fetchCurrentUser();
        }
        
        // Functions
        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                alert('Please enter email and password');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (data.token) {
                    localStorage.setItem('token', data.token);
                    token = data.token;
                    currentUser = data;
                    showApp();
                    initializeSocket();
                } else {
                    alert(data.message || 'Login failed');
                }
            } catch (error) {
                console.error('Login error:', error);
                alert('An error occurred during login');
            }
        }
        
        async function fetchCurrentUser() {
            try {
                const response = await fetch(`${API_URL}/users/me`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Authentication failed');
                }
                
                currentUser = await response.json();
                showApp();
                initializeSocket();
            } catch (error) {
                console.error('Auth error:', error);
                localStorage.removeItem('token');
                token = null;
            }
        }
        
        function showApp() {
            loginContainer.style.display = 'none';
            appContainer.style.display = 'block';
            logMessage('Logged in as: ' + currentUser.username);
        }
        
        function initializeSocket() {
            socket = io('http://localhost:4400', {
                query: { token },
                transports: ['websocket', 'polling']
            });
            
            socket.on('connect', () => {
                connectionStatus.textContent = 'Connected to server';
                connectionStatus.className = 'connection-status status-connected';
                logMessage('Socket connected: ' + socket.id);
                
                // Send user ID to server
                socket.emit('user_connected', currentUser._id);
                
                // Initialize Agora manager
                initializeAgora();
            });
            
            socket.on('connect_error', (error) => {
                console.error('Socket connection error:', error);
                connectionStatus.textContent = 'Connection error: ' + error.message;
                connectionStatus.className = 'connection-status status-disconnected';
                logMessage('Connection error: ' + error.message);
            });
            
            socket.on('disconnect', () => {
                connectionStatus.textContent = 'Disconnected from server';
                connectionStatus.className = 'connection-status status-disconnected';
                logMessage('Socket disconnected');
            });
            
            // User status updates
            socket.on('user_status', (data) => {
                updateUserStatus(data.userId, data.status);
            });
            
            // Incoming call signal
            socket.on('incoming_call', (data) => {
                logMessage(`Incoming call from ${data.callerName}`);
                showIncomingCall(data);
            });
            
            // Call status updates
            socket.on('call_status_update', (data) => {
                logMessage(`Call status update: ${data.status}`);
                
                if (data.status === 'ended') {
                    handleCallEnded();
                }
            });
            
            // Get online users
            fetchUsers();
        }
        
        function initializeAgora() {
            // Create Agora manager
            agoraManager = new AgoraManager(socket, currentUser._id);
            logMessage('Agora Manager initialized');
        }
        
        async function fetchUsers() {
            try {
                const response = await fetch(`${API_URL}/users/all`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const users = await response.json();
                renderUsers(users);
            } catch (error) {
                console.error('Error fetching users:', error);
                logMessage('Error fetching users: ' + error.message);
            }
        }
        
        function renderUsers(users) {
            usersList.innerHTML = '';
            
            if (users.length === 0) {
                usersList.innerHTML = '<div class="user-item">No users available</div>';
                return;
            }
            
            users.forEach(user => {
                if (user._id === currentUser._id) return; // Skip current user
                
                const userItem = document.createElement('div');
                userItem.className = `user-item ${selectedUserId === user._id ? 'selected' : ''}`;
                userItem.dataset.userId = user._id;
                
                const statusClass = user.status === 'online' ? 'online' : 'offline';
                
                userItem.innerHTML = `
                    <span class="status ${statusClass}"></span>
                    <span class="username">${user.username}</span>
                `;
                
                userItem.addEventListener('click', () => selectUser(user._id, user.username));
                
                usersList.appendChild(userItem);
            });
        }
        
        function selectUser(userId, username) {
            selectedUserId = userId;
            selectedUsername = username;
            
            // Update UI
            document.querySelectorAll('.user-item').forEach(item => {
                item.classList.toggle('selected', item.dataset.userId === userId);
            });
            
            // Enable call buttons
            audioCallBtn.disabled = false;
            videoCallBtn.disabled = false;
            
            logMessage(`Selected user: ${username}`);
        }
        
        function updateUserStatus(userId, status) {
            const userItem = document.querySelector(`.user-item[data-userId="${userId}"]`);
            if (userItem) {
                const statusIndicator = userItem.querySelector('.status');
                if (statusIndicator) {
                    statusIndicator.className = `status ${status === 'online' ? 'online' : 'offline'}`;
                }
            }
        }
        
        async function initiateCall(callType) {
            if (!selectedUserId) {
                alert('Please select a user to call');
                return;
            }
            
            logMessage(`Initiating ${callType} call to ${selectedUsername}...`);
            
            try {
                // Create call record on the server
                const callResponse = await fetch(`${API_URL}/calls`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        receiverId: selectedUserId,
                        callType: callType,
                        status: 'initiated'
                    })
                });
                
                if (!callResponse.ok) {
                    throw new Error('Failed to create call record');
                }
                
                const callRecord = await callResponse.json();
                const callId = callRecord.callId;
                
                logMessage('Call record created with ID: ' + callId);
                
                // Normally you'd request an Agora token from your server here
                // For demo purposes, we'll proceed without a real token
                logMessage('Proceeding without Agora token (demo only)');
                
                // Start the call with Agora
                const success = await agoraManager.initiateCall(selectedUserId, callType, callId);
                
                if (success) {
                    endCallBtn.disabled = false;
                    micBtn.disabled = false;
                    videoBtn.disabled = callType === 'audio';
                    audioCallBtn.disabled = true;
                    videoCallBtn.disabled = true;
                }
            } catch (error) {
                logMessage('Error initiating call: ' + error.message);
                alert('Failed to initiate call: ' + error.message);
            }
        }
        
        function toggleMicrophone() {
            if (agoraManager && agoraManager.callInProgress) {
                const muted = agoraManager.toggleAudio();
                micBtn.classList.toggle('muted', muted);
                logMessage(muted ? 'Microphone muted' : 'Microphone unmuted');
            }
        }
        
        function toggleVideo() {
            if (agoraManager && agoraManager.callInProgress) {
                const videoOff = agoraManager.toggleVideo();
                videoBtn.classList.toggle('muted', videoOff);
                logMessage(videoOff ? 'Camera turned off' : 'Camera turned on');
            }
        }
        
        function endCall() {
            if (agoraManager) {
                agoraManager.endCall();
            }
            
            handleCallEnded();
            logMessage('Call ended');
        }
        
        function showIncomingCall(data) {
            callerInfo.textContent = `${data.callerName || 'Someone'} is calling (${data.callType})`;
            incomingCallDiv.style.display = 'block';
            
            // Store call data
            incomingCallDiv.dataset.callerId = data.callerId;
            incomingCallDiv.dataset.callId = data.callId;
            incomingCallDiv.dataset.callType = data.callType;
            
            // Auto-hide after 30 seconds if not answered
            setTimeout(() => {
                if (incomingCallDiv.style.display === 'block') {
                    incomingCallDiv.style.display = 'none';
                    rejectCall(data.callerId, data.callId, 'timeout');
                }
            }, 30000);
        }
        
        async function acceptIncomingCall() {
            const callerId = incomingCallDiv.dataset.callerId;
            const callId = incomingCallDiv.dataset.callId;
            const callType = incomingCallDiv.dataset.callType;
            
            incomingCallDiv.style.display = 'none';
            
            try {
                // Update call status to connected
                await fetch(`${API_URL}/calls/${callId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        status: 'connected'
                    })
                });
                
                // Normally you'd request an Agora token here
                // For demo, we'll proceed without a real token
                logMessage('Proceeding without Agora token (demo only)');
                
                // Join Agora channel
                const success = await agoraManager.joinCall(callerId, callType, callId);
                
                if (success) {
                    endCallBtn.disabled = false;
                    micBtn.disabled = false;
                    videoBtn.disabled = callType === 'audio';
                    audioCallBtn.disabled = true;
                    videoCallBtn.disabled = true;
                    
                    logMessage('Call accepted');
                } else {
                    logMessage('Failed to join Agora channel');
                    alert('Failed to join call');
                }
            } catch (error) {
                logMessage('Error accepting call: ' + error.message);
                alert('Failed to accept call: ' + error.message);
            }
        }
        
        async function rejectIncomingCall() {
            const callerId = incomingCallDiv.dataset.callerId;
            const callId = incomingCallDiv.dataset.callId;
            
            incomingCallDiv.style.display = 'none';
            await rejectCall(callerId, callId, 'rejected');
            logMessage('Call rejected');
        }
        
        async function rejectCall(callerId, callId, reason) {
            try {
                // Update call status to rejected
                await fetch(`${API_URL}/calls/${callId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        status: 'rejected'
                    })
                });
                
                // Notify caller that call was rejected
                socket.emit('call_rejected', {
                    callerId: callerId,
                    callId: callId,
                    reason: reason
                });
            } catch (error) {
                console.error('Error rejecting call:', error);
            }
        }
        
        function handleCallEnded() {
            // Reset UI
            endCallBtn.disabled = true;
            micBtn.disabled = true;
            videoBtn.disabled = true;
            audioCallBtn.disabled = false;
            videoCallBtn.disabled = false;
            
            // Reset media buttons state
            micBtn.classList.remove('muted');
            videoBtn.classList.remove('muted');
            
            if (agoraManager) {
                agoraManager.resetUI();
            }
        }
        
        function logMessage(message) {
            const time = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.textContent = `[${time}] ${message}`;
            callLog.appendChild(logEntry);
            callLog.scrollTop = callLog.scrollHeight;
        }
        
        // Agora Manager Class
        class AgoraManager {
            constructor(socket, userId) {
                this.socket = socket;
                this.userId = userId;
                this.client = null;
                this.localAudioTrack = null;
                this.localVideoTrack = null;
                this.callInProgress = false;
                this.callType = null;
                this.receiverId = null;
                this.callId = null;
                this.audioMuted = false;
                this.videoOff = false;
                
                this.setupSocketListeners();
                this.initializeAgoraClient();
                
                logMessage('Agora Manager initialized');
            }
            
            setupSocketListeners() {
                // Listen for call related events
                this.socket.on('call_rejected', (data) => {
                    logMessage('Call rejected by remote peer');
                    if (this.callInProgress) {
                        this.endCall(true);
                        alert('Call was rejected');
                    }
                });
                
                this.socket.on('call_answered', (data) => {
                    logMessage('Call answered by remote peer');
                });
                
                this.socket.on('call_ended', (data) => {
                    logMessage('Remote peer ended the call');
                    if (this.callInProgress) {
                        this.endCall(true);
                    }
                });
            }
            
            initializeAgoraClient() {
                // Initialize Agora client
                this.client = AgoraRTC.createClient({ mode: 'rtc', codec: 'vp8' });
                
                // Setup event handlers
                this.client.on('user-published', async (user, mediaType) => {
                    logMessage(`Remote user ${user.uid} published ${mediaType} track`);
                    
                    // Subscribe to the remote user
                    await this.client.subscribe(user, mediaType);
                    
                    if (mediaType === 'video') {
                        // Get the remote video track
                        const remoteVideoTrack = user.videoTrack;
                        // Play the remote video track
                        remoteVideoTrack.play(remoteStreamContainer);
                        logMessage('Remote video track is playing');
                    }
                    
                    if (mediaType === 'audio') {
                        // Get the remote audio track
                        const remoteAudioTrack = user.audioTrack;
                        // Play the remote audio track
                        remoteAudioTrack.play();
                        logMessage('Remote audio track is playing');
                    }
                });
                
                this.client.on('user-unpublished', (user, mediaType) => {
                    logMessage(`Remote user ${user.uid} unpublished ${mediaType} track`);
                });
                
                this.client.on('user-left', (user) => {
                    logMessage(`Remote user ${user.uid} left the channel`);
                    if (this.callInProgress) {
                        this.endCall(true);
                        alert('Remote user left the call');
                    }
                });
                
                this.client.on('connection-state-change', (curState, prevState) => {
                    logMessage(`Connection state changed from ${prevState} to ${curState}`);
                });
            }
            
            async initiateCall(receiverId, callType, callId, agoraToken = null) {
                try {
                    this.receiverId = receiverId;
                    this.callType = callType;
                    this.callId = callId;
                    
                    // Join the Agora channel
                    // Normally you'd use a token from your server
                    // For demo, we use the App ID credential mode (not secure for production)
                    try {
                        // Join the Agora channel using the callId as channel name
                        await this.client.join(AGORA_APP_ID, callId, agoraToken, null);
                        logMessage(`Joined Agora channel: ${callId}`);
                    } catch (joinError) {
                        console.error('Error joining Agora channel:', joinError);
                        logMessage('Failed to join Agora channel: ' + joinError.message);
                        return false;
                    }
                    
                    // Create and publish the local tracks
                    try {
                        // Create audio track
                        this.localAudioTrack = await AgoraRTC.createMicrophoneAudioTrack();
                        
                        // Create video track if this is a video call
                        if (callType === 'video') {
                            this.localVideoTrack = await AgoraRTC.createCameraVideoTrack();
                            this.localVideoTrack.play(localStreamContainer);
                        }
                        
                        // Publish the local tracks to the channel
                        await this.client.publish(callType === 'video' 
                            ? [this.localAudioTrack, this.localVideoTrack] 
                            : [this.localAudioTrack]);
                        
                        logMessage(`Published local ${callType} tracks to the channel`);
                    } catch (trackError) {
                        console.error('Error with local tracks:', trackError);
                        logMessage('Failed to create or publish media tracks: ' + trackError.message);
                        await this.client.leave();
                        return false;
                    }
                    
                    // Send signal to the receiver through our socket
                    this.socket.emit('webrtc_offer', {
                        receiverId: receiverId,
                        callType: callType,
                        callId: callId
                    });
                    
                    logMessage(`Call signal sent to ${receiverId}`);
                    this.callInProgress = true;
                    
                    return true;
                } catch (error) {
                    console.error('Error initiating call:', error);
                    logMessage('Error initiating call: ' + error.message);
                    this.cleanup();
                    return false;
                }
            }
            
            async joinCall(callerId, callType, callId, agoraToken = null) {
                try {
                    this.receiverId = callerId; // In this case, caller becomes receiver
                    this.callType = callType;
                    this.callId = callId;
                    
                    // Join the Agora channel
                    try {
                        await this.client.join(AGORA_APP_ID, callId, agoraToken, null);
                        logMessage(`Joined Agora channel: ${callId}`);
                    } catch (joinError) {
                        console.error('Error joining Agora channel:', joinError);
                        logMessage('Failed to join Agora channel: ' + joinError.message);
                        return false;
                    }
                    
                    // Create and publish the local tracks
                    try {
                        // Create audio track
                        this.localAudioTrack = await AgoraRTC.createMicrophoneAudioTrack();
                        
                        // Create video track if this is a video call
                        if (callType === 'video') {
                            this.localVideoTrack = await AgoraRTC.createCameraVideoTrack();
                            this.localVideoTrack.play(localStreamContainer);
                        }
                        
                        // Publish the local tracks to the channel
                        await this.client.publish(callType === 'video' 
                            ? [this.localAudioTrack, this.localVideoTrack] 
                            : [this.localAudioTrack]);
                        
                        logMessage(`Published local ${callType} tracks to the channel`);
                    } catch (trackError) {
                        console.error('Error with local tracks:', trackError);
                        logMessage('Failed to create or publish media tracks: ' + trackError.message);
                        await this.client.leave();
                        return false;
                    }
                    
                    // Notify the caller that we answered
                    this.socket.emit('call_answered', {
                        callerId: callerId,
                        callId: callId
                    });
                    
                    logMessage('Call answered signal sent');
                    this.callInProgress = true;
                    
                    return true;
                } catch (error) {
                    console.error('Error joining call:', error);
                    logMessage('Error joining call: ' + error.message);
                    this.cleanup();
                    return false;
                }
            }
            
            toggleAudio() {
                if (!this.localAudioTrack) return false;
                
                if (this.audioMuted) {
                    this.localAudioTrack.setMuted(false);
                    this.audioMuted = false;
                    return false;
                } else {
                    this.localAudioTrack.setMuted(true);
                    this.audioMuted = true;
                    return true;
                }
            }
            
            toggleVideo() {
                if (!this.localVideoTrack) return false;
                
                if (this.videoOff) {
                    this.localVideoTrack.setMuted(false);
                    this.videoOff = false;
                    return false;
                } else {
                    this.localVideoTrack.setMuted(true);
                    this.videoOff = true;
                    return true;
                }
            }
            
            async endCall(remoteEnded = false) {
                try {
                    if (!remoteEnded) {
                        // Send end call signal to the remote user
                        this.socket.emit('call_ended', {
                            receiverId: this.receiverId,
                            callId: this.callId
                        });
                        
                        // Update call status on the server
                        try {
                            await fetch(`${API_URL}/calls/${this.callId}`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${token}`
                                },
                                body: JSON.stringify({
                                    status: 'ended'
                                })
                            });
                            
                            logMessage('Call status updated to: ended');
                        } catch (error) {
                            console.error('Error updating call status:', error);
                            logMessage('Error updating call status: ' + error.message);
                        }
                    }
                    
                    // Clean up resources
                    this.cleanup();
                    
                    // Reset UI state
                    handleCallEnded();
                } catch (error) {
                    console.error('Error ending call:', error);
                    logMessage('Error ending call: ' + error.message);
                }
            }
            
            async cleanup() {
                // Close and clean up audio track
                if (this.localAudioTrack) {
                    this.localAudioTrack.close();
                    this.localAudioTrack = null;
                }
                
                // Close and clean up video track
                if (this.localVideoTrack) {
                    this.localVideoTrack.close();
                    this.localVideoTrack = null;
                }
                
                // Leave the channel
                if (this.client) {
                    try {
                        await this.client.leave();
                        logMessage('Left the Agora channel');
                    } catch (error) {
                        console.error('Error leaving channel:', error);
                        logMessage('Error leaving channel: ' + error.message);
                    }
                }
                
                // Reset state
                this.callInProgress = false;
                this.receiverId = null;
                this.callId = null;
                this.audioMuted = false;
                this.videoOff = false;
                
                logMessage('Resources cleaned up');
            }
            
            resetUI() {
                // Clear video containers
                localStreamContainer.innerHTML = '';
                remoteStreamContainer.innerHTML = '';
            }
        }
    </script>
</body>
</html>